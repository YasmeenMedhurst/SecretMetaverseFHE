<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contract Address Tester</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #00ff00; }
        .container { max-width: 800px; margin: 0 auto; }
        input { padding: 10px; margin: 10px 0; width: 100%; background: #333; color: #00ff00; border: 1px solid #555; }
        button { padding: 10px 20px; margin: 10px 5px; background: #333; color: #00ff00; border: 1px solid #555; cursor: pointer; }
        button:hover { background: #555; }
        .result { margin: 20px 0; padding: 15px; background: #222; border: 1px solid #555; }
        .success { border-color: #00ff00; }
        .error { border-color: #ff0000; color: #ff0000; }
        .log { background: #111; padding: 10px; font-size: 12px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Secret Metaverse Contract Tester</h1>

        <div>
            <label>Contract Address:</label>
            <input type="text" id="contractAddress" placeholder="0x..." value="0xC6BD14B68169DbC558046910707e725824C8391e">
        </div>

        <div>
            <button onclick="connectWallet()">Connect Wallet</button>
            <button onclick="testContract()">Test Contract</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>

        <div class="result" id="status">Status: Not connected</div>

        <div class="log" id="log"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.0/dist/ethers.umd.min.js"></script>
    <script>
        let provider, signer, userAccount;

        const CONTRACT_ABI = [
            "function vote(bool _vote) external",
            "function getVoteCount() external view returns (uint256)",
            "function hasVoted(address user) external view returns (bool)",
            "function owner() external view returns (address)",
            "function virtualWorldCount() external view returns (uint256)",
            "function proposalCount() external view returns (uint256)"
        ];

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff0000' : type === 'success' ? '#00ff00' : '#ffffff';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, success = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = success ? 'result success' : 'result error';
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function connectWallet() {
            try {
                log("üîó Connecting to MetaMask...");

                if (!window.ethereum) {
                    throw new Error("MetaMask not found");
                }

                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                log(`üë§ Connected to account: ${accounts[0]}`);

                // Initialize provider
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAccount = await signer.getAddress();

                // Get network info
                const network = await provider.getNetwork();
                log(`üåê Network: ${network.name} (Chain ID: ${network.chainId})`);

                // Check if on Sepolia
                if (Number(network.chainId) === 11155111) {
                    log("‚úÖ Connected to Sepolia testnet", "success");
                    updateStatus(`Connected to Sepolia: ${userAccount}`, true);
                } else {
                    log(`‚ö†Ô∏è Not on Sepolia (Chain ID: ${network.chainId})`, "error");
                    updateStatus(`Wrong network - Chain ID: ${network.chainId}`, false);
                }

                // Get balance
                const balance = await provider.getBalance(userAccount);
                log(`üí∞ Balance: ${ethers.formatEther(balance)} ETH`);

            } catch (error) {
                log(`‚ùå Connection failed: ${error.message}`, "error");
                updateStatus(`Connection failed: ${error.message}`, false);
            }
        }

        async function testContract() {
            try {
                if (!provider) {
                    throw new Error("Please connect wallet first");
                }

                const contractAddress = document.getElementById('contractAddress').value.trim();
                if (!contractAddress) {
                    throw new Error("Please enter contract address");
                }

                log(`üîç Testing contract at: ${contractAddress}`);

                // Check if contract exists
                const code = await provider.getCode(contractAddress);
                if (code === '0x') {
                    throw new Error("No contract found at this address");
                }
                log("‚úÖ Contract code found", "success");

                // Create contract instance
                const contract = new ethers.Contract(contractAddress, CONTRACT_ABI, signer);
                log("üìã Contract instance created");

                // Test basic calls
                try {
                    const owner = await contract.owner();
                    log(`üëë Contract owner: ${owner}`, "success");
                } catch (e) {
                    log(`‚ùå Failed to get owner: ${e.message}`, "error");
                }

                try {
                    const voteCount = await contract.getVoteCount();
                    log(`üó≥Ô∏è Vote count: ${voteCount.toString()}`, "success");
                } catch (e) {
                    log(`‚ùå Failed to get vote count: ${e.message}`, "error");
                }

                try {
                    const hasVoted = await contract.hasVoted(userAccount);
                    log(`‚úÖ Has voted: ${hasVoted}`, "success");
                } catch (e) {
                    log(`‚ùå Failed to check vote status: ${e.message}`, "error");
                }

                try {
                    const worldCount = await contract.virtualWorldCount();
                    log(`üåç Virtual worlds: ${worldCount.toString()}`, "success");
                } catch (e) {
                    log(`‚ùå Failed to get world count: ${e.message}`, "error");
                }

                try {
                    const proposalCount = await contract.proposalCount();
                    log(`üìã Proposals: ${proposalCount.toString()}`, "success");
                } catch (e) {
                    log(`‚ùå Failed to get proposal count: ${e.message}`, "error");
                }

                // Test gas estimation
                try {
                    const gasEstimate = await contract.vote.estimateGas(true);
                    log(`‚õΩ Gas estimate for vote: ${gasEstimate.toString()}`, "success");
                } catch (e) {
                    log(`‚ùå Gas estimation failed: ${e.message}`, "error");
                }

                updateStatus("Contract test completed - check log for details", true);

            } catch (error) {
                log(`üí• Test failed: ${error.message}`, "error");
                updateStatus(`Test failed: ${error.message}`, false);
            }
        }

        // Auto-connect on page load
        window.addEventListener('load', () => {
            log("üöÄ Contract tester loaded");
            log("üìã Please connect your wallet and test the contract address");
        });
    </script>
</body>
</html>